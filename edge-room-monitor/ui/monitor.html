<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>ÊÇ£ËÄÖË¶ãÂÆà„Çä„Ç∑„Çπ„ÉÜ„É†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #eee;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .video-panel {
            flex: 1;
            position: relative;
            background: #16213e;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 0;
            padding: 10px;
        }

        .video-card {
            background: #0f3460;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        #videoCanvas {
            max-width: 100%;
            max-height: 100%;
            cursor: pointer;
            border-radius: 4px;
        }

        .sidebar {
            width: 350px;
            background: #16213e;
            padding: 20px;
            overflow-y: auto;
            border-left: 2px solid #0f3460;
        }

        h1 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #00d9ff;
            border-bottom: 2px solid #0f3460;
            padding-bottom: 10px;
        }

        h2 {
            font-size: 16px;
            margin: 20px 0 10px 0;
            color: #00d9ff;
        }

        .mode-indicator {
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            margin-bottom: 15px;
            font-weight: bold;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-indicator.auto {
            background: #27ae60;
        }

        .mode-indicator.manual {
            background: #e67e22;
        }

        .info-box {
            background: #0f3460;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 12px;
            line-height: 1.6;
            color: #bbb;
        }

        .alert-item {
            background: #e74c3c;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #c0392b;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .alert-type {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .alert-message {
            font-size: 12px;
            margin-bottom: 4px;
        }

        .alert-time {
            font-size: 11px;
            color: #bbb;
        }

        .person-item {
            background: #0f3460;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            border-left: 4px solid #00d9ff;
        }

        .person-id {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .person-status {
            font-size: 12px;
            color: #bbb;
        }

        button {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            background: #0f3460;
            color: #00d9ff;
            border: 2px solid #00d9ff;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(0, 217, 255, 0.3);
        }

        button:hover,
        button:active {
            background: #00d9ff;
            color: #16213e;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        button.danger {
            background: #e74c3c;
            border-color: #c0392b;
            color: white;
        }

        button.danger:hover {
            background: #c0392b;
        }

        .no-alerts {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 14px;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-box {
            background: #0f3460;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #00d9ff;
        }

        .stat-label {
            font-size: 11px;
            color: #bbb;
            margin-top: 4px;
        }

        /* „Çπ„Éû„ÉõÁ∏¶ÊåÅ„Å°ÂØæÂøú */
        @media (max-width: 768px) and (orientation: portrait) {
            .container {
                flex-direction: column;
            }

            .video-panel {
                height: 50vh;
                min-height: 300px;
                padding: 15px;
            }

            .video-card {
                width: 95%;
                height: 95%;
            }

            .sidebar {
                width: 100%;
                height: 50vh;
                border-left: none;
                border-top: 2px solid #0f3460;
                padding: 15px;
            }

            h1 {
                font-size: 16px;
                margin-bottom: 10px;
            }

            h2 {
                font-size: 14px;
                margin: 12px 0 8px 0;
            }

            .stats {
                margin-bottom: 10px;
            }

            .stat-box {
                padding: 8px;
            }

            .stat-value {
                font-size: 20px;
            }
        }

        /* „Çπ„Éû„ÉõÊ®™ÊåÅ„Å°„Éª„Çø„Éñ„É¨„ÉÉ„ÉàÂØæÂøú */
        @media (max-width: 1024px) and (orientation: landscape) {
            .container {
                flex-direction: row;
            }

            .video-panel {
                flex: 1;
            }

            .sidebar {
                width: 320px;
            }

            h1 {
                font-size: 18px;
            }

            h2 {
                font-size: 15px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="video-panel">
            <div class="video-card">
                <canvas id="videoCanvas"></canvas>
            </div>
        </div>
        <div class="sidebar">
            <h1>üëÅÔ∏è Ë¶ãÂÆà„ÇäÂêõ v1.0.0 <span style="font-size: 13px; color: #7f8c8d; font-weight: normal;">prototype</span>
            </h1>

            <div class="stats">
                <div class="stat-box">
                    <div class="stat-value" id="trackedCount">0</div>
                    <div class="stat-label">ËøΩË∑°‰∏≠</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="alertCount">0</div>
                    <div class="stat-label">„Ç¢„É©„Éº„Éà</div>
                </div>
            </div>

            <h2>üö® „Ç¢„É©„Éº„Éà</h2>
            <div id="alertsList">
                <div class="no-alerts">„Ç¢„É©„Éº„Éà„Å™„Åó</div>
            </div>

            <h2>üë• ËøΩË∑°‰∏≠„ÅÆÊÇ£ËÄÖ</h2>
            <div id="personsList">
                <div class="no-alerts">ËøΩË∑°‰∏≠„ÅÆÊÇ£ËÄÖ„Å™„Åó</div>
            </div>

            <div class="controls">
                <button id="resetBtn">üîÑ „É™„Çª„ÉÉ„Éà</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('videoCanvas');
        const ctx = canvas.getContext('2d');

        let img = new Image();
        let detections = [];
        let alerts = [];
        let lastAlertCount = 0;
        let autoRegisterMode = true;

        const ALERT_TYPES = {
            1: '‚ö†Ô∏è Ëª¢ÂÄí',
            2: '‚ö†Ô∏è „Éô„ÉÉ„ÉâËêΩ‰∏ã',
            3: '‚ö†Ô∏è „Éô„ÉÉ„ÉâÈõ¢ËÑ±',
            4: 'üìç Ê®™„Åü„Çè„ÇäÁ∂ôÁ∂ö',
            5: '‚ùì ÂæòÂæä„ÅÆÂèØËÉΩÊÄß'
        };

        const COLORS = ['#00ff00', '#00ffff', '#ffff00', '#ff00ff'];

        // MJPEG stream
        img.onload = function () {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            // Draw detections
            detections.forEach(det => {
                const bbox = det.bbox;
                const isRegistered = det.registered;
                const fixedId = det.fixed_id;

                if (isRegistered) {
                    ctx.strokeStyle = COLORS[fixedId % 4];
                    ctx.fillStyle = COLORS[fixedId % 4];
                    ctx.lineWidth = 3;
                } else {
                    ctx.strokeStyle = '#ff0000';
                    ctx.fillStyle = '#ff0000';
                    ctx.lineWidth = 2;
                }

                ctx.strokeRect(bbox.left, bbox.top, bbox.width, bbox.height);

                const label = isRegistered ? `ÊÇ£ËÄÖ ${fixedId}` : `Êú™ÁôªÈå≤`;
                const labelY = bbox.top > 25 ? bbox.top - 8 : bbox.top + bbox.height + 20;

                ctx.font = 'bold 16px sans-serif';
                const textWidth = ctx.measureText(label).width;
                ctx.fillRect(bbox.left, labelY - 18, textWidth + 10, 22);
                ctx.fillStyle = '#000';
                ctx.fillText(label, bbox.left + 5, labelY - 2);
            });

            img.src = '/stream?' + new Date().getTime();
        };

        img.onerror = function () {
            setTimeout(() => {
                img.src = '/stream?' + new Date().getTime();
            }, 1000);
        };

        img.src = '/stream';

        // Click to unregister (auto mode only)
        canvas.addEventListener('click', async (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);

            for (const det of detections) {
                const bbox = det.bbox;
                if (x >= bbox.left && x <= bbox.left + bbox.width &&
                    y >= bbox.top && y <= bbox.top + bbox.height) {

                    if (det.registered) {
                        // Unregister (tap to remove from tracking)
                        await fetch('/api/unregister', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ nvtracker_id: det.nvtracker_id })
                        });
                        console.log('Unregistered:', det.nvtracker_id);
                    }
                    break;
                }
            }
        });

        async function updateData() {
            try {
                const [detRes, alertRes, configRes] = await Promise.all([
                    fetch('/api/detections'),
                    fetch('/api/alerts'),
                    fetch('/api/config')
                ]);

                const detData = await detRes.json();
                const alertData = await alertRes.json();
                const configData = await configRes.json();

                detections = detData.detections || [];
                alerts = alertData.alerts || [];
                autoRegisterMode = configData.auto_register;

                if (alerts.length > lastAlertCount) {
                    // Play sound
                }
                lastAlertCount = alerts.length;

                updateUI();
            } catch (err) {
                console.error('Failed to fetch data:', err);
            }
        }

        function updateUI() {
            const trackedCount = detections.filter(d => d.registered).length;
            document.getElementById('trackedCount').textContent = trackedCount;
            document.getElementById('alertCount').textContent = alerts.filter(a => !a.acknowledged).length;

            const alertsList = document.getElementById('alertsList');
            const activeAlerts = alerts.filter(a => !a.acknowledged);
            if (activeAlerts.length === 0) {
                alertsList.innerHTML = '<div class="no-alerts">„Ç¢„É©„Éº„Éà„Å™„Åó</div>';
            } else {
                alertsList.innerHTML = activeAlerts.map((alert, idx) => {
                    const date = new Date(alert.timestamp);
                    const timeStr = date.toLocaleTimeString('ja-JP');
                    const alertType = ALERT_TYPES[alert.type] || '‰∏çÊòé';
                    return `
            <div class="alert-item" onclick="acknowledgeAlert(${alert.index})" style="cursor: pointer;" title="„ÇØ„É™„ÉÉ„ÇØ„ÅßÁ¢∫Ë™ç">
              <div class="alert-type">${alertType}</div>
              <div class="alert-message">ÊÇ£ËÄÖ ${alert.fixed_id}: ${alert.message}</div>
              <div class="alert-time">${timeStr}</div>
            </div>
          `;
                }).reverse().join('');
            }

            const personsList = document.getElementById('personsList');
            const tracked = detections.filter(d => d.registered);
            if (tracked.length === 0) {
                personsList.innerHTML = '<div class="no-alerts">ËøΩË∑°‰∏≠„ÅÆÊÇ£ËÄÖ„Å™„Åó</div>';
            } else {
                personsList.innerHTML = tracked.map(det => `
          <div class="person-item">
            <div class="person-id">ÊÇ£ËÄÖ ${det.fixed_id}</div>
            <div class="person-status">bbox: ${Math.round(det.bbox.width)}x${Math.round(det.bbox.height)}</div>
            <div class="person-status">‰ø°È†ºÂ∫¶: ${(det.confidence * 100).toFixed(1)}%</div>
          </div>
        `).join('');
            }
        }

        async function acknowledgeAlert(index) {
            await fetch('/api/acknowledge_alert', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ index: index })
            });
            updateData();
        }

        let resetClickCount = 0;
        let resetClickTimer = null;

        async function resetAll(btn) {
            // „ÉÄ„Éñ„É´„Çø„ÉÉ„Éó„Åß„É™„Çª„ÉÉ„ÉàÔºàÁ¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞„Å™„ÅóÔºâ
            resetClickCount++;

            if (resetClickCount === 1) {
                btn.textContent = 'üîÑ „ÇÇ„ÅÜ‰∏ÄÂ∫¶Êäº„Åó„Å¶„É™„Çª„ÉÉ„Éà';
                btn.style.background = '#e67e22';

                resetClickTimer = setTimeout(() => {
                    resetClickCount = 0;
                    btn.textContent = 'üîÑ „É™„Çª„ÉÉ„Éà';
                    btn.style.background = '#0f3460';
                }, 2000);
                return;
            }

            // 2ÂõûÁõÆ„ÅÆ„ÇØ„É™„ÉÉ„ÇØ
            clearTimeout(resetClickTimer);
            resetClickCount = 0;

            btn.disabled = true;
            btn.textContent = 'üîÑ „É™„Çª„ÉÉ„Éà‰∏≠...';
            btn.style.background = '#0f3460';

            try {
                // ‰∏¶ÂàóÂÆüË°å„ÅßÈ´òÈÄüÂåñ
                await Promise.all([
                    fetch('/api/clear', { method: 'POST' }),
                    fetch('/api/clear_alerts', { method: 'POST' })
                ]);
                alerts = [];
                lastAlertCount = 0;
                await updateData();

                btn.textContent = '‚úì „É™„Çª„ÉÉ„ÉàÂÆå‰∫Ü';
                setTimeout(() => {
                    btn.textContent = 'üîÑ „É™„Çª„ÉÉ„Éà';
                }, 1500);
            } catch (err) {
                console.error('Reset failed:', err);
                btn.textContent = '‚úó „É™„Çª„ÉÉ„ÉàÂ§±Êïó';
                setTimeout(() => {
                    btn.textContent = 'üîÑ „É™„Çª„ÉÉ„Éà';
                }, 2000);
            } finally {
                btn.disabled = false;
            }
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆöÔºà„Çπ„Éû„ÉõÂØæÂøúÔºâ
        const resetBtn = document.getElementById('resetBtn');
        if (resetBtn) {
            console.log('Reset button found, attaching event listener');
            resetBtn.addEventListener('click', function (e) {
                console.log('Reset button clicked!');
                e.preventDefault();
                e.stopPropagation();
                resetAll(this);
            }, { passive: false });

            // „Çø„ÉÉ„ÉÅ„Ç§„Éô„É≥„Éà„ÇÇËøΩÂä†Ôºà„Çπ„Éû„ÉõÁî®Ôºâ
            resetBtn.addEventListener('touchend', function (e) {
                console.log('Reset button touched!');
                e.preventDefault();
                e.stopPropagation();
                resetAll(this);
            }, { passive: false });
        } else {
            console.error('Reset button not found!');
        }

        setInterval(updateData, 1000);
        updateData();
    </script>
</body>

</html>